<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ЛИГАТА НА КОМУНАТА 2025 - Преглед</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Fallback стилове за таблици */
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    .w-12 { width: 3rem; }
    .w-32 { width: 8rem; }
    .w-48 { width: 12rem; }
    .w-16 { width: 4rem; }
    .w-1\/3 { width: 33.333333%; }
    .w-1\/6 { width: 16.666667%; }
    .bg-green-200 { background-color: #c6efce; }
    .bg-yellow-200 { background-color: #ffeeba; }
    .bg-pink-200 { background-color: #ffc1cc; }
    .bg-white { background-color: #ffffff; }
    .bg-green-500 { background-color: #22c55e; color: #fff; }
    .bg-yellow-500 { background-color: #eab308; color: #fff; }
    .bg-pink-500 { background-color: #ec4899; color: #fff; }
    .bg-gray-300 { background-color: #d1d5db; }
    .bg-green-100 { background-color: #dcfce7; color: #000; }
    .bg-yellow-100 { background-color: #fef9c3; color: #000; }
    .bg-red-100 { background-color: #fee2e2; color: #000; }
    .bg-gray-100 { background-color: #f3f4f6; }
    @media (max-width: 640px) {
      table { display: block; overflow-x: auto; white-space: nowrap; }
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold text-center mb-4">ЛИГАТА НА КОМУНАТА 2025 - Преглед</h1>

    <!-- Класиране -->
    <div id="standings" class="mb-6">
      <h2 class="text-2xl font-semibold mb-2">Класиране</h2>
      <div class="mb-2 flex flex-wrap gap-2 items-center">
        <button onclick="toggleView()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" id="toggleButton">Покажи пълно класиране</button>
        <span id="lastUpdated" class="text-sm text-gray-600"></span>
      </div>
      <table class="w-full border-collapse border table-auto" id="standingsTable">
        <thead id="standingsHeader"></thead>
        <tbody id="standingsBody"></tbody>
      </table>
      <div class="mt-4">
        <h3 class="text-xl font-semibold mb-2">Легенда</h3>
        <div class="grid grid-cols-1 gap-4">
          <div class="flex items-center">
            <span class="inline-block w-6 h-6 text-center text-white font-bold rounded bg-green-500 mr-2">1</span>
            <span class="mr-2">1-во място: <span id="prize-1">150 лв. (награда)</span></span>
          </div>
          <div class="flex items-center">
            <span class="inline-block w-6 h-6 text-center text-white font-bold rounded bg-green-500 mr-2">2</span>
            <span class="mr-2">2-ро място: <span id="prize-2">100 лв. (награда)</span></span>
          </div>
          <div class="flex items-center">
            <span class="inline-block w-6 h-6 text-center text-white font-bold rounded bg-green-500 mr-2">3</span>
            <span class="mr-2">3-то място: <span id="prize-3">50 лв. (награда)</span></span>
          </div>
          <div class="flex items-center">
            <span class="inline-block w-6 h-6 text-center text-white font-bold rounded bg-yellow-500 mr-2">4</span>
            <span class="mr-2">4-то място: <span id="prize-4">GOLDEN CARD (награда)</span></span>
          </div>
          <div class="flex items-center">
            <span class="inline-block w-6 h-6 text-center text-white font-bold rounded bg-pink-500 mr-2"></span>
            <span class="mr-2">Царя на Балъците: <span id="prize-13-16">15 лв</span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Програма -->
    <div id="schedule" class="mb-6">
      <h2 class="text-2xl font-semibold mb-2">Програма</h2>
      <div id="scheduleContainer"></div>
    </div>
  </div>

  <script>
    const JSON_URL = 'https://filedn.eu/l6SJDgOejWxLG2TzBJ6aX15/%D0%9B%D0%98%D0%93%D0%90%D0%A2%D0%90%20%D0%9D%D0%90%20%D0%9A%D0%9E%D0%9C%D0%A3%D0%9D%D0%90%D0%A2%D0%90%2025%7C26/ligata%2025-26.json'; // Въведи тук директния pCloud линк (напр. 'https://filedn.com/.../ligata_na_komunata.json')
    let teams = Array(16).fill().map((_, i) => `Участник ${i + 1}`);
    let matches = [];
    let results = {};
    let prizes = {
      '1': '150 лв. (награда)',
      '2': '100 лв. (награда)',
      '3': '50 лв. (награда)',
      '4': 'GOLDEN CARD (награда)',
      '13-16': '15 лв'
    };
    const numTeams = 16;
    let isShortView = true;

    function formatNumber(num) {
      if (num === '') return '-';
      const n = parseFloat(num);
      if (isNaN(n)) return '-';
      return Number.isInteger(n) ? n.toString() : n.toFixed(1);
    }

    function getTeamForm(team) {
      const form = [];
      const teamMatches = matches
        .map((match, index) => ({ match, index }))
        .filter(({ match }) => match.home === team || match.away === team)
        .filter(({ index }) => results[index] && results[index].homeGoals !== '' && results[index].awayGoals !== '')
        .sort((a, b) => a.match.round - b.match.round)
        .slice(-5);

      teamMatches.forEach(({ match, index }) => {
        const homeGoals = parseFloat(results[index].homeGoals);
        const awayGoals = parseFloat(results[index].awayGoals);
        let outcome;
        if (match.home === team) {
          if (homeGoals > awayGoals) outcome = 'П';
          else if (homeGoals < awayGoals) outcome = 'З';
          else outcome = 'Р';
        } else {
          if (awayGoals > homeGoals) outcome = 'П';
          else if (awayGoals < homeGoals) outcome = 'З';
          else outcome = 'Р';
        }
        form.push(outcome);
      });

      while (form.length < 5) {
        form.push('-');
      }
      return form.reverse(); // Обръщане на реда: най-актуален мач вляво, най-стар вдясно
    }

    function getHeadToHeadPoints(teamA, teamB) {
      let pointsA = 0;
      let pointsB = 0;
      matches.forEach((match, index) => {
        if (!results[index] || results[index].homeGoals === '' || results[index].awayGoals === '') return;
        if ((match.home === teamA && match.away === teamB) || (match.home === teamB && match.away === teamA)) {
          const homeGoals = parseFloat(results[index].homeGoals);
          const awayGoals = parseFloat(results[index].awayGoals);
          if (match.home === teamA && match.away === teamB) {
            if (homeGoals > awayGoals) pointsA += 3;
            else if (homeGoals < awayGoals) pointsB += 3;
            else {
              if (homeGoals >= 10 && awayGoals >= 10) {
                pointsA += 1.5;
                pointsB += 1.5;
              } else {
                pointsA += 1;
                pointsB += 1;
              }
            }
          } else if (match.home === teamB && match.away === teamA) {
            if (homeGoals > awayGoals) pointsB += 3;
            else if (homeGoals < awayGoals) pointsA += 3;
            else {
              if (homeGoals >= 10 && awayGoals >= 10) {
                pointsA += 1.5;
                pointsB += 1.5;
              } else {
                pointsA += 1;
                pointsB += 1;
              }
            }
          }
        }
      });
      return { pointsA, pointsB };
    }

    function getAwayGoals(team) {
      let awayGoals = 0;
      matches.forEach((match, index) => {
        if (!results[index] || results[index].homeGoals === '' || results[index].awayGoals === '') return;
        if (match.away === team) {
          awayGoals += parseFloat(results[index].awayGoals);
        }
      });
      return awayGoals;
    }

    function renderStandings() {
      const standings = teams.slice(0, numTeams).map(team => ({
        team,
        matches: 0,
        wins: 0,
        draws: 0,
        superDraws: 0,
        losses: 0,
        bonusPoints: 0,
        goalsFor: 0,
        goalsAgainst: 0,
        goalDifference: 0,
        points: 0,
        awayGoals: 0
      }));

      matches.forEach((match, index) => {
        if (!results[index] || results[index].homeGoals === '' || results[index].awayGoals === '') return;
        const home = standings.find(s => s.team === match.home);
        const away = standings.find(s => s.team === match.away);
        const homeGoals = parseFloat(results[index].homeGoals);
        const awayGoals = parseFloat(results[index].awayGoals);

        home.matches++;
        away.matches++;
        home.goalsFor += homeGoals;
        away.goalsFor += awayGoals;
        home.goalsAgainst += awayGoals;
        away.goalsAgainst += homeGoals;
        home.goalDifference = home.goalsFor - home.goalsAgainst;
        away.goalDifference = away.goalsFor - away.goalsAgainst;
        home.awayGoals += match.home === home.team ? 0 : awayGoals;
        away.awayGoals += match.away === away.team ? awayGoals : 0;

        if (homeGoals > awayGoals) {
          home.wins++;
          away.losses++;
          home.points += 3;
          if (awayGoals >= 10) {
            away.bonusPoints += 0.5;
            away.points += 0.5;
          }
        } else if (homeGoals < awayGoals) {
          away.wins++;
          home.losses++;
          away.points += 3;
          if (homeGoals >= 11.5) {
            home.bonusPoints += 0.5;
            home.points += 0.5;
          }
        } else {
          if (homeGoals >= 10 && awayGoals >= 10) {
            home.superDraws++;
            away.superDraws++;
            home.points += 1.5;
            away.points += 1.5;
          } else {
            home.draws++;
            away.draws++;
            home.points += 1;
            away.points += 1;
          }
        }
      });

      standings.sort((a, b) => {
        if (a.points !== b.points) return b.points - a.points;
        if (a.goalDifference !== b.goalDifference) return b.goalDifference - a.goalDifference;
        if (a.goalsFor !== b.goalsFor) return b.goalsFor - a.goalsFor;
        const { pointsA, pointsB } = getHeadToHeadPoints(a.team, b.team);
        if (pointsA !== pointsB) return pointsB - pointsA;
        return b.awayGoals - a.awayGoals;
      });

      const groups = [];
      let currentGroup = [standings[0]];
      for (let i = 1; i < standings.length; i++) {
        const prev = standings[i - 1];
        const curr = standings[i];
        const { pointsA, pointsB } = getHeadToHeadPoints(prev.team, curr.team);
        const sameRank = prev.points === curr.points &&
                         prev.goalDifference === curr.goalDifference &&
                         prev.goalsFor === curr.goalsFor &&
                         pointsA === pointsB &&
                         prev.awayGoals === curr.awayGoals;
        if (sameRank) {
          currentGroup.push(curr);
        } else {
          groups.push(currentGroup);
          currentGroup = [curr];
        }
      }
      groups.push(currentGroup);

      const header = document.getElementById('standingsHeader');
      const tbody = document.getElementById('standingsBody');
      header.innerHTML = '';
      tbody.innerHTML = '';

      if (isShortView) {
        header.innerHTML = `
          <tr class="bg-gray-200">
            <th class="border p-2 w-12">Място</th>
            <th class="border p-2 w-32">Отбор</th>
            <th class="border p-2 w-16">Гол/Доп</th>
            <th class="border p-2 w-16">Гол. разлика</th>
            <th class="border p-2 w-16">Точки</th>
          </tr>
        `;
      } else {
        header.innerHTML = `
          <tr class="bg-gray-200">
            <th class="border p-2 w-12">Място</th>
            <th class="border p-2 w-32">Отбор</th>
            <th class="border p-2 w-48">Моментна форма</th>
            <th class="border p-2 w-16">Мачове</th>
            <th class="border p-2 w-16">Победи</th>
            <th class="border p-2 w-16">Равенства</th>
            <th class="border p-2 w-16">Супер равенства</th>
            <th class="border p-2 w-16">Загуби</th>
            <th class="border p-2 w-16">Бонус голове</th>
            <th class="border p-2 w-16">Гол/Доп</th>
            <th class="border p-2 w-16">Гол. разлика</th>
            <th class="border p-2 w-16">Точки</th>
          </tr>
        `;
      }

      let rank = 1;
      groups.forEach((group, groupIndex) => {
        group.forEach((s, index) => {
          const row = document.createElement('tr');
          let rowClass = '';
          let rankClass = '';
          const displayRank = group.length > 1 ? '-' : rank;
          if (rank <= 3) {
            rowClass = 'bg-green-200';
            rankClass = 'bg-green-500';
          } else if (rank === 4) {
            rowClass = 'bg-yellow-200';
            rankClass = 'bg-yellow-500';
          } else if (rank >= numTeams - 3) {
            rowClass = 'bg-pink-200';
            rankClass = 'bg-pink-500';
          } else {
            rowClass = 'bg-white';
            rankClass = 'bg-gray-300';
          }
          row.className = rowClass;

          const form = getTeamForm(s.team);
          const formHtml = form.map(outcome => {
            let bgClass = '';
            if (outcome === 'П') bgClass = 'bg-green-500';
            else if (outcome === 'Р') bgClass = 'bg-yellow-500';
            else if (outcome === 'З') bgClass = 'bg-red-500';
            else bgClass = 'bg-gray-300';
            return `<span class="inline-block w-6 h-6 text-center text-white font-bold rounded ${bgClass}">${outcome}</span>`;
          }).join(' ');

          const goalDifferenceDisplay = s.goalDifference >= 0 ? `+${formatNumber(s.goalDifference)}` : formatNumber(s.goalDifference);
          const goalsDisplay = `${formatNumber(s.goalsFor)}-${formatNumber(s.goalsAgainst)}`;
          const bonusPointsDisplay = formatNumber(s.bonusPoints);
          const pointsDisplay = formatNumber(s.points);

          if (isShortView) {
            row.innerHTML = `
              <td class="border p-2 text-center"><span class="inline-block w-6 h-6 text-center text-white font-bold rounded ${rankClass}">${displayRank}</span></td>
              <td class="border p-2">${s.team}</td>
              <td class="border p-2">${goalsDisplay}</td>
              <td class="border p-2">${goalDifferenceDisplay}</td>
              <td class="border p-2">${pointsDisplay}</td>
            `;
          } else {
            row.innerHTML = `
              <td class="border p-2 text-center"><span class="inline-block w-6 h-6 text-center text-white font-bold rounded ${rankClass}">${displayRank}</span></td>
              <td class="border p-2">${s.team}</td>
              <td class="border p-2">${formHtml}</td>
              <td class="border p-2">${s.matches}</td>
              <td class="border p-2">${s.wins}</td>
              <td class="border p-2">${s.draws}</td>
              <td class="border p-2">${s.superDraws}</td>
              <td class="border p-2">${s.losses}</td>
              <td class="border p-2">${bonusPointsDisplay}</td>
              <td class="border p-2">${goalsDisplay}</td>
              <td class="border p-2">${goalDifferenceDisplay}</td>
              <td class="border p-2">${pointsDisplay}</td>
            `;
          }
          tbody.appendChild(row);
        });
        rank += group.length;
      });
    }

    function toggleView() {
      isShortView = !isShortView;
      document.getElementById('toggleButton').innerText = isShortView ? 'Покажи пълно класиране' : 'Покажи съкратено класиране';
      renderStandings();
    }

    function renderSchedule() {
      console.log('Рендиране на програмата...');
      const container = document.getElementById('scheduleContainer');
      container.innerHTML = '';
      if (matches.length === 0) {
        container.innerHTML = '<p class="text-red-500">Няма налични мачове за показване.</p>';
        return;
      }
      const rounds = [...new Set(matches.map(m => m.round))];
      rounds.forEach(round => {
        const roundDiv = document.createElement('div');
        roundDiv.className = 'mb-6';
        roundDiv.innerHTML = `<h3 class="text-xl font-bold mb-2">Кръг ${round}</h3>`;
        const table = document.createElement('table');
        table.className = 'w-full border-collapse border';
        table.innerHTML = `
          <thead>
            <tr class="bg-gray-200">
              <th class="border p-2 w-1/3">Домакин</th>
              <th class="border p-2 w-1/6">Резултат</th>
              <th class="border p-2 w-1/3">Гост</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');
        matches.filter(m => m.round === round).forEach((match, index) => {
          const globalIndex = matches.findIndex(m => m.round === match.round && m.home === match.home && m.away === match.away);
          const row = document.createElement('tr');
          const homeGoals = results[globalIndex]?.homeGoals ?? '';
          const awayGoals = results[globalIndex]?.awayGoals ?? '';
          let homeClass = '';
          let awayClass = '';
          let resultClass = 'font-bold bg-gray-100';
          if (homeGoals !== '' && awayGoals !== '') {
            const homeG = parseFloat(homeGoals);
            const awayG = parseFloat(awayGoals);
            if (homeG > awayG) {
              homeClass = 'bg-green-100 font-bold';
              awayClass = 'bg-red-100';
            } else if (homeG < awayG) {
              homeClass = 'bg-red-100';
              awayClass = 'bg-green-100 font-bold';
            } else {
              homeClass = 'bg-yellow-100';
              awayClass = 'bg-yellow-100';
            }
          }
          const resultDisplay = `${formatNumber(homeGoals)} : ${formatNumber(awayGoals)}`;
          row.innerHTML = `
            <td class="border p-2 ${homeClass}">${match.home}</td>
            <td class="border p-2 text-center ${resultClass}">${resultDisplay}</td>
            <td class="border p-2 ${awayClass}">${match.away}</td>
          `;
          tbody.appendChild(row);
        });
        roundDiv.appendChild(table);
        container.appendChild(roundDiv);
      });
    }

    function importFromUrl() {
      if (!JSON_URL) {
        console.log('Няма зададен JSON_URL, пропускане на автоматично импортиране.');
        return;
      }
      fetch(JSON_URL)
        .then(response => {
          if (!response.ok) throw new Error('Мрежова грешка: ' + response.status);
          return response.json();
        })
        .then(data => {
          teams = data.teams || teams;
          matches = data.matches || matches;
          results = data.results || results;
          prizes = data.prizes || prizes;
          saveData();
          renderStandings();
          renderSchedule();
          loadPrizes();
          updateLastUpdated();
        })
        .catch(error => {
          console.error('Грешка при импортиране от URL: ' + error.message);
        });
    }

    function updateLastUpdated() {
      const lastUpdated = new Date().toLocaleString('bg-BG', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
      document.getElementById('lastUpdated').innerText = `Последно обновено: ${lastUpdated}`;
    }

    function saveData() {
      const data = { numTeams, teams, matches, results, prizes };
      localStorage.setItem('ligata_na_komunata', JSON.stringify(data));
    }

    function loadPrizes() {
      const prizeElements = {
        '1': document.getElementById('prize-1'),
        '2': document.getElementById('prize-2'),
        '3': document.getElementById('prize-3'),
        '4': document.getElementById('prize-4'),
        '13-16': document.getElementById('prize-13-16')
      };
      for (let place in prizeElements) {
        prizeElements[place].innerText = prizes[place];
      }
    }

    function loadData() {
      console.log('Зареждане на данни от localStorage...');
      const data = JSON.parse(localStorage.getItem('ligata_na_komunata'));
      if (data) {
        teams = data.teams || teams;
        matches = data.matches || matches;
        results = data.results || results;
        prizes = data.prizes || prizes;
      }
      renderStandings();
      renderSchedule();
      loadPrizes();
      // Първоначално импортиране от URL
      importFromUrl();
      // Автоматично опресняване на всеки 60 секунди
      setInterval(() => {
        importFromUrl();
      }, 60000);
    }

    window.onload = () => {
      console.log('Страницата се зареди, извикване на loadData()...');
      loadData();
    };
  </script>
</body>
</html>
